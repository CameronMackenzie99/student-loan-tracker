import { assert, expect, test } from "vitest";
import { defaultRowOptions } from "./defaultRowOptions";
import type { CalcOptions } from "./projection";
import {
  calculateFullData,
  calculateYearRow,
  calculateInitialYearRow,
  calculatePreGraduationRows,
} from "./projection";
import type { FormDataType } from "@/components/MultiStepForm";

const options: CalcOptions = {
  graduatingYear: 2021,
  loanPeriod: 30,
  repaymentThreshold: 27295,
  salary: 30000,
  rowOptions: defaultRowOptions,
};

const formInput: FormDataType = {
  student: "graduate",
  plan: "plan2",
  data: {
    currentLoanBalance: 5000,
    graduatingYear: 2021,
  },
};

const formInput2: FormDataType = {
  student: "graduate",
  plan: "plan2",
  data: {
    currentLoanBalance: 50000,
    graduatingYear: 2021,
  },
};

test("Calculate year data when first calculated row", () => {
  const startingRowInputs = {
    totalDebt: 5000,
    interestRate: options.rowOptions.planInterestRate,
    annualRepayment: 0,
    totalRepaid: 0,
  };
  const result = calculateInitialYearRow(startingRowInputs, options);

  const expectedRow = {
    currentLoanYear: 2,
    graduatingYear: 2021,
    salary: 30000,
    calendarYear: 2023,
    totalDebt: 5000,
    interestRate: 3,
    annualInterest: 150,
    repaymentThreshold: 27295,
    annualRepayment: 243.45,
    totalRepaid: 243.45,
    yearsUntilWiped: 29,
  };

  assert.deepEqual(result, expectedRow);
});

test("Calculate year data when not first calculated row", () => {
  const rowInputs = {
    yearsUntilWiped: 27,
    calendarYear: 2023,
    totalDebt: 5000,
    annualInterest: 150,
    annualRepayment: 243.45,
    salary: 30000,
    repaymentThreshold: 27295,
    totalRepaid: 243.45,
  };

  const result = calculateYearRow(rowInputs, options);

  const expected = {
    annualInterest: 166.82270000000003,
    annualRepayment: 280.18800000000005,
    calendarYear: 2024,
    currentLoanYear: 3,
    graduatingYear: 2021,
    interestRate: 3.4,
    repaymentThreshold: 28386.8,
    salary: 31500,
    totalDebt: 4906.55,
    totalRepaid: 523.638,
    yearsUntilWiped: 26,
  };

  assert.deepEqual(result, expected);
});

const expected1 = [
  5000, 4907, 4793, 4636, 4432, 4174, 3859, 3480, 3032, 2508, 1901, 1204, 409,
  14, 0,
];

const expected2 = [
  50000, 51257, 52719, 54192, 55672, 57157, 58643, 60127, 61605, 63072, 64524,
  65956, 67363, 68737, 70073, 71364, 72602, 73777, 74882, 75907, 76841, 77672,
  78389, 78977, 79424, 79714, 79830, 79754, 79469,
];

test.each([
  [formInput, expected1],
  [formInput2, expected2],
])("Calculate full total debt data", (formInput, expected) => {
  const rowArray = calculateFullData(formInput, options);

  const totalDebtArray = rowArray.map((row) =>
    Math.round(row?.totalDebt ?? -1)
  );

  expect(totalDebtArray).toEqual(expected);
});

test("calculate pre-graduation rows", () => {
  const result = calculatePreGraduationRows(2023, 3, 15000, 3);

  expect(result).toEqual([
    {
      annualInterest: 450,
      calendarYear: 2024,
      interestRate: 3,
      totalDebt: 15000,
    },
    {
      annualInterest: 913.5,
      calendarYear: 2025,
      interestRate: 3,
      totalDebt: 30450,
    },
    {
      annualInterest: 1390.905,
      calendarYear: 2026,
      interestRate: 3,
      totalDebt: 46363.5,
    },
  ]);
});

test("calculate current student rows", () => {
  const result = calculateFullData(
    {
      student: "current",
      plan: "plan5",
      data: {
        courseLength: 3,
        courseStartYear: 2023,
        yearlyMaintenance: 7000,
        yearlyTuition: 9250,
      },
    },
    options
  );

  assert.deepEqual(result, [
    {
      calendarYear: 2024,
      totalDebt: 16250,
      interestRate: 3,
      annualInterest: 487.5,
    },
    {
      calendarYear: 2025,
      totalDebt: 32987.5,
      interestRate: 3,
      annualInterest: 989.625,
    },
    {
      calendarYear: 2026,
      totalDebt: 50227.125,
      interestRate: 3,
      annualInterest: 1506.81375,
    },
    {
      currentLoanYear: 6,
      graduatingYear: 2021,
      salary: 34823.480076,
      calendarYear: 2027,
      totalDebt: 51733.93875,
      interestRate: 3.4,
      annualInterest: 1758.9539175000002,
      repaymentThreshold: 31381.8147371872,
      annualRepayment: 309.749880493152,
      totalRepaid: 309.749880493152,
      yearsUntilWiped: 29,
    },
    {
      currentLoanYear: 7,
      graduatingYear: 2021,
      salary: 36564.6540798,
      calendarYear: 2028,
      totalDebt: 53183.14278700685,
      interestRate: 3.4,
      annualInterest: 1808.226854758233,
      repaymentThreshold: 32637.08732667469,
      annualRepayment: 353.4810077812778,
      totalRepaid: 663.2308882744298,
      yearsUntilWiped: 28,
    },
    {
      currentLoanYear: 8,
      graduatingYear: 2021,
      salary: 38392.88678379,
      calendarYear: 2029,
      totalDebt: 54637.888633983806,
      interestRate: 3.4,
      annualInterest: 1857.6882135554495,
      repaymentThreshold: 33942.570819741675,
      annualRepayment: 400.5284367643495,
      totalRepaid: 1063.7593250387795,
      yearsUntilWiped: 27,
    },
    {
      currentLoanYear: 9,
      graduatingYear: 2021,
      salary: 40312.531122979504,
      calendarYear: 2030,
      totalDebt: 56095.04841077491,
      interestRate: 3.4,
      annualInterest: 1907.231645966347,
      repaymentThreshold: 35300.273652531345,
      annualRepayment: 451.1031723403343,
      totalRepaid: 1514.8624973791138,
      yearsUntilWiped: 26,
    },
    {
      currentLoanYear: 10,
      graduatingYear: 2021,
      salary: 42328.15767912848,
      calendarYear: 2031,
      totalDebt: 57551.17688440092,
      interestRate: 3.4,
      annualInterest: 1956.7400140696313,
      repaymentThreshold: 36712.2845986326,
      annualRepayment: 505.4285772446295,
      totalRepaid: 2020.2910746237433,
      yearsUntilWiped: 25,
    },
    {
      currentLoanYear: 11,
      graduatingYear: 2021,
      salary: 44444.56556308491,
      calendarYear: 2032,
      totalDebt: 59002.48832122592,
      interestRate: 3.4,
      annualInterest: 2006.0846029216816,
      repaymentThreshold: 38180.77598257791,
      annualRepayment: 563.74106224563,
      totalRepaid: 2584.032136869373,
      yearsUntilWiped: 24,
    },
    {
      currentLoanYear: 12,
      graduatingYear: 2021,
      salary: 46666.79384123915,
      calendarYear: 2033,
      totalDebt: 60444.83186190198,
      interestRate: 3.4,
      annualInterest: 2055.124283304667,
      repaymentThreshold: 39708.00702188102,
      annualRepayment: 626.2908137422318,
      totalRepaid: 3210.322950611605,
      yearsUntilWiped: 23,
    },
    {
      currentLoanYear: 13,
      graduatingYear: 2021,
      salary: 49000.13353330111,
      calendarYear: 2034,
      totalDebt: 61873.665331464406,
      interestRate: 3.4,
      annualInterest: 2103.70462126979,
      repaymentThreshold: 41296.32730275626,
      annualRepayment: 693.3425607490362,
      totalRepaid: 3903.665511360641,
      yearsUntilWiped: 22,
    },
    {
      currentLoanYear: 14,
      graduatingYear: 2021,
      salary: 51450.140209966165,
      calendarYear: 2035,
      totalDebt: 63284.02739198516,
      interestRate: 3.4,
      annualInterest: 2151.656931327496,
      repaymentThreshold: 42948.18039486651,
      annualRepayment: 765.1763833589688,
      totalRepaid: 4668.84189471961,
      yearsUntilWiped: 21,
    },
    {
      currentLoanYear: 15,
      graduatingYear: 2021,
      salary: 54022.647220464474,
      calendarYear: 2036,
      totalDebt: 64670.507939953684,
      interestRate: 3.4,
      annualInterest: 2198.797269958425,
      repaymentThreshold: 44666.10761066117,
      annualRepayment: 842.0885648822971,
      totalRepaid: 5510.9304596019065,
      yearsUntilWiped: 20,
    },
    {
      currentLoanYear: 16,
      graduatingYear: 2021,
      salary: 56723.7795814877,
      calendarYear: 2037,
      totalDebt: 66027.21664502981,
      interestRate: 3.4,
      annualInterest: 2244.925365931014,
      repaymentThreshold: 46452.75191508762,
      annualRepayment: 924.3924899760076,
      totalRepaid: 6435.322949577914,
      yearsUntilWiped: 19,
    },
    {
      currentLoanYear: 17,
      graduatingYear: 2021,
      salary: 59559.96856056209,
      calendarYear: 2038,
      totalDebt: 67347.74952098483,
      interestRate: 3.4,
      annualInterest: 2289.823483713484,
      repaymentThreshold: 48310.86199169113,
      annualRepayment: 1012.4195911983867,
      totalRepaid: 7447.742540776301,
      yearsUntilWiped: 18,
    },
    {
      currentLoanYear: 18,
      graduatingYear: 2021,
      salary: 62537.9669885902,
      calendarYear: 2039,
      totalDebt: 68625.15341349992,
      interestRate: 3.4,
      annualInterest: 2333.2552160589976,
      repaymentThreshold: 50243.29647135877,
      annualRepayment: 1106.5203465508282,
      totalRepaid: 8554.26288732713,
      yearsUntilWiped: 17,
    },
    {
      currentLoanYear: 19,
      graduatingYear: 2021,
      salary: 65664.8653380197,
      calendarYear: 2040,
      totalDebt: 69851.8882830081,
      interestRate: 3.4,
      annualInterest: 2374.9642016222756,
      repaymentThreshold: 52253.02833021312,
      annualRepayment: 1207.0653307025927,
      totalRepaid: 9761.328218029723,
      yearsUntilWiped: 16,
    },
    {
      currentLoanYear: 20,
      graduatingYear: 2021,
      salary: 68948.1086049207,
      calendarYear: 2041,
      totalDebt: 71019.78715392778,
      interestRate: 3.4,
      annualInterest: 2414.6727632335446,
      repaymentThreshold: 54343.14946342165,
      annualRepayment: 1314.4463227349138,
      totalRepaid: 11075.774540764636,
      yearsUntilWiped: 15,
    },
    {
      currentLoanYear: 21,
      graduatingYear: 2021,
      salary: 72395.51403516674,
      calendarYear: 2042,
      totalDebt: 72120.0135944264,
      interestRate: 3.4,
      annualInterest: 2452.080462210498,
      repaymentThreshold: 56516.87544195852,
      annualRepayment: 1429.0774733887397,
      totalRepaid: 12504.852014153375,
      yearsUntilWiped: 14,
    },
    {
      currentLoanYear: 22,
      graduatingYear: 2021,
      salary: 76015.28973692507,
      calendarYear: 2043,
      totalDebt: 73143.01658324816,
      interestRate: 3.4,
      annualInterest: 2486.8625638304375,
      repaymentThreshold: 58777.55045963686,
      annualRepayment: 1551.3965349559387,
      totalRepaid: 14056.248549109314,
      yearsUntilWiped: 13,
    },
    {
      currentLoanYear: 23,
      graduatingYear: 2021,
      salary: 79816.05422377132,
      calendarYear: 2044,
      totalDebt: 74078.48261212265,
      interestRate: 3.4,
      annualInterest: 2518.66840881217,
      repaymentThreshold: 61128.65247802234,
      annualRepayment: 1681.8661571174084,
      totalRepaid: 15738.114706226723,
      yearsUntilWiped: 12,
    },
    {
      currentLoanYear: 24,
      graduatingYear: 2021,
      salary: 83806.8569349599,
      calendarYear: 2045,
      totalDebt: 74915.28486381742,
      interestRate: 3.4,
      annualInterest: 2547.1196853697925,
      repaymentThreshold: 63573.798577143236,
      annualRepayment: 1820.9752522034996,
      totalRepaid: 17559.089958430224,
      yearsUntilWiped: 11,
    },
    {
      currentLoanYear: 25,
      graduatingYear: 2021,
      salary: 87997.1997817079,
      calendarYear: 2046,
      totalDebt: 75641.42929698371,
      interestRate: 3.4,
      annualInterest: 2571.8085960974463,
      repaymentThreshold: 66116.75052022896,
      annualRepayment: 1969.240433533104,
      totalRepaid: 19528.33039196333,
      yearsUntilWiped: 10,
    },
    {
      currentLoanYear: 26,
      graduatingYear: 2021,
      salary: 92397.05977079329,
      calendarYear: 2047,
      totalDebt: 76243.99745954805,
      interestRate: 3.4,
      annualInterest: 2592.2959136246336,
      repaymentThreshold: 68761.42054103813,
      annualRepayment: 2127.2075306779648,
      totalRepaid: 21655.537922641295,
      yearsUntilWiped: 9,
    },
    {
      currentLoanYear: 27,
      graduatingYear: 2021,
      salary: 97016.91275933296,
      calendarYear: 2048,
      totalDebt: 76709.08584249472,
      interestRate: 3.4,
      annualInterest: 2608.1089186448207,
      repaymentThreshold: 71511.87736267965,
      annualRepayment: 2295.4531856987983,
      totalRepaid: 23950.991108340095,
      yearsUntilWiped: 8,
    },
    {
      currentLoanYear: 28,
      graduatingYear: 2021,
      salary: 101867.7583972996,
      calendarYear: 2049,
      totalDebt: 77021.74157544074,
      interestRate: 3.4,
      annualInterest: 2618.739213564985,
      repaymentThreshold: 74372.35245718683,
      annualRepayment: 2474.5865346101496,
      totalRepaid: 26425.577642950244,
      yearsUntilWiped: 7,
    },
    {
      currentLoanYear: 29,
      graduatingYear: 2021,
      salary: 106961.14631716459,
      calendarYear: 2050,
      totalDebt: 77165.89425439558,
      interestRate: 3.4,
      annualInterest: 2623.64040464945,
      repaymentThreshold: 77347.24655547431,
      annualRepayment: 2665.2509785521247,
      totalRepaid: 29090.82862150237,
      yearsUntilWiped: 6,
    },
    {
      currentLoanYear: 30,
      graduatingYear: 2021,
      salary: 112309.20363302283,
      calendarYear: 2051,
      totalDebt: 77124.2836804929,
      interestRate: 3.4,
      annualInterest: 2622.2256451367584,
      repaymentThreshold: 80441.13641769328,
      annualRepayment: 2868.126049379659,
      totalRepaid: 31958.954670882027,
      yearsUntilWiped: 5,
    },
    {
      currentLoanYear: 31,
      graduatingYear: 2021,
      salary: 117924.66381467397,
      calendarYear: 2052,
      totalDebt: 76878.38327625,
      interestRate: 3.4,
      annualInterest: 2613.8650313925,
      repaymentThreshold: 83658.78187440101,
      annualRepayment: 3083.929374624566,
      totalRepaid: 35042.884045506595,
      yearsUntilWiped: 4,
    },
    {
      currentLoanYear: 32,
      graduatingYear: 2021,
      salary: 123820.89700540768,
      calendarYear: 2053,
      totalDebt: 76408.31893301793,
      interestRate: 3.4,
      annualInterest: 2597.88284372261,
      repaymentThreshold: 87005.13314937706,
      annualRepayment: 3313.418747042756,
      totalRepaid: 38356.30279254935,
      yearsUntilWiped: 3,
    },
    {
      currentLoanYear: 33,
      graduatingYear: 2021,
      salary: 130011.94185567807,
      calendarYear: 2054,
      totalDebt: 75692.78302969778,
      interestRate: 3.4,
      annualInterest: 2573.5546230097248,
      repaymentThreshold: 90485.33847535214,
      annualRepayment: 3557.394304229334,
      totalRepaid: 41913.697096778684,
      yearsUntilWiped: 2,
    },
    {
      currentLoanYear: 34,
      graduatingYear: 2021,
      salary: 136512.538948462,
      calendarYear: 2055,
      totalDebt: 74708.94334847816,
      interestRate: 3.4,
      annualInterest: 2540.1040738482575,
      repaymentThreshold: 94104.75201436623,
      annualRepayment: 3816.700824068619,
      totalRepaid: 45730.3979208473,
      yearsUntilWiped: 1,
    },
    {
      currentLoanYear: 35,
      graduatingYear: 2021,
      salary: 143338.1658958851,
      calendarYear: 2056,
      totalDebt: 73432.3465982578,
      interestRate: 3.4,
      annualInterest: 2496.6997843407657,
      repaymentThreshold: 97868.94209494088,
      annualRepayment: 4092.2301420849785,
      totalRepaid: 49822.62806293228,
      yearsUntilWiped: 0,
    },
  ]);
});
test("calculate graduate student rows", () => {
  const result = calculateFullData(
    {
      student: "graduate",
      plan: "plan2",
      data: {
        currentLoanBalance: 5000,
        graduatingYear: 2022,
      },
    },
    options
  );

  expect(result).toEqual([
    {
      currentLoanYear: 2,
      graduatingYear: 2021,
      salary: 30000,
      calendarYear: 2023,
      totalDebt: 5000,
      interestRate: 3,
      annualInterest: 150,
      repaymentThreshold: 27295,
      annualRepayment: 243.45,
      totalRepaid: 243.45,
      yearsUntilWiped: 29,
    },
    {
      currentLoanYear: 3,
      graduatingYear: 2021,
      salary: 31500,
      calendarYear: 2024,
      totalDebt: 4906.55,
      interestRate: 3.4,
      annualInterest: 166.82270000000003,
      repaymentThreshold: 28386.8,
      annualRepayment: 280.18800000000005,
      totalRepaid: 523.638,
      yearsUntilWiped: 28,
    },
    {
      currentLoanYear: 4,
      graduatingYear: 2021,
      salary: 33075,
      calendarYear: 2025,
      totalDebt: 4793.1847,
      interestRate: 3.4,
      annualInterest: 162.9682798,
      repaymentThreshold: 29522.272,
      annualRepayment: 319.7455199999999,
      totalRepaid: 843.3835199999999,
      yearsUntilWiped: 27,
    },
    {
      currentLoanYear: 5,
      graduatingYear: 2021,
      salary: 34728.75,
      calendarYear: 2026,
      totalDebt: 4636.407459800001,
      interestRate: 3.4,
      annualInterest: 157.63785363320002,
      repaymentThreshold: 30703.162880000003,
      annualRepayment: 362.3028407999997,
      totalRepaid: 1205.6863607999994,
      yearsUntilWiped: 26,
    },
    {
      currentLoanYear: 6,
      graduatingYear: 2021,
      salary: 36465.1875,
      calendarYear: 2027,
      totalDebt: 4431.742472633201,
      interestRate: 3.4,
      annualInterest: 150.67924406952883,
      repaymentThreshold: 31931.289395200005,
      annualRepayment: 408.05082943199955,
      totalRepaid: 1613.737190231999,
      yearsUntilWiped: 25,
    },
    {
      currentLoanYear: 7,
      graduatingYear: 2021,
      salary: 38288.446875,
      calendarYear: 2028,
      totalDebt: 4174.37088727073,
      interestRate: 3.4,
      annualInterest: 141.92861016720485,
      repaymentThreshold: 33208.540971008006,
      annualRepayment: 457.1915313592796,
      totalRepaid: 2070.9287215912786,
      yearsUntilWiped: 24,
    },
    {
      currentLoanYear: 8,
      graduatingYear: 2021,
      salary: 40202.869218750006,
      calendarYear: 2029,
      totalDebt: 3859.107966078656,
      interestRate: 3.4,
      annualInterest: 131.2096708466743,
      repaymentThreshold: 34536.882609848326,
      annualRepayment: 509.9387948011511,
      totalRepaid: 2580.86751639243,
      yearsUntilWiped: 23,
    },
    {
      currentLoanYear: 9,
      graduatingYear: 2021,
      salary: 42213.012679687505,
      calendarYear: 2030,
      totalDebt: 3480.378842124179,
      interestRate: 3.4,
      annualInterest: 118.33288063222209,
      repaymentThreshold: 35918.35791424226,
      annualRepayment: 566.518928890072,
      totalRepaid: 3147.386445282502,
      yearsUntilWiped: 22,
    },
    {
      currentLoanYear: 10,
      graduatingYear: 2021,
      salary: 44323.66331367188,
      calendarYear: 2031,
      totalDebt: 3032.192793866329,
      interestRate: 3.4,
      annualInterest: 103.09455499145518,
      repaymentThreshold: 37355.092230811955,
      annualRepayment: 627.1713974573933,
      totalRepaid: 3774.557842739895,
      yearsUntilWiped: 21,
    },
    {
      currentLoanYear: 11,
      graduatingYear: 2021,
      salary: 46539.846479355474,
      calendarYear: 2032,
      totalDebt: 2508.1159514003907,
      interestRate: 3.4,
      annualInterest: 85.2759423476133,
      repaymentThreshold: 38849.29592004444,
      annualRepayment: 692.1495503379932,
      totalRepaid: 4466.707393077888,
      yearsUntilWiped: 20,
    },
    {
      currentLoanYear: 12,
      graduatingYear: 2021,
      salary: 48866.83880332325,
      calendarYear: 2033,
      totalDebt: 1901.2423434100106,
      interestRate: 3.4,
      annualInterest: 64.64223967594036,
      repaymentThreshold: 40403.26775684622,
      annualRepayment: 761.7213941829327,
      totalRepaid: 5228.42878726082,
      yearsUntilWiped: 19,
    },
    {
      currentLoanYear: 13,
      graduatingYear: 2021,
      salary: 51310.180743489414,
      calendarYear: 2034,
      totalDebt: 1204.1631889030182,
      interestRate: 3.4,
      annualInterest: 40.941548422702624,
      repaymentThreshold: 42019.39846712007,
      annualRepayment: 836.1704048732413,
      totalRepaid: 6064.599192134061,
      yearsUntilWiped: 18,
    },
    {
      currentLoanYear: 14,
      graduatingYear: 2021,
      salary: 53875.68978066389,
      calendarYear: 2035,
      totalDebt: 408.93433245247957,
      interestRate: 3.4,
      annualInterest: 13.903767303384306,
      repaymentThreshold: 43700.17440580487,
      annualRepayment: 408.93433245247957,
      totalRepaid: 6473.533524586541,
      yearsUntilWiped: 17,
    },
    {
      currentLoanYear: 15,
      graduatingYear: 2021,
      salary: 56569.474269697086,
      calendarYear: 2036,
      totalDebt: 13.903767303384313,
      interestRate: 3.4,
      annualInterest: 0.4727280883150667,
      repaymentThreshold: 45448.181382037066,
      annualRepayment: 13.903767303384313,
      totalRepaid: 6487.437291889925,
      yearsUntilWiped: 16,
    },
    {
      currentLoanYear: 16,
      graduatingYear: 2021,
      salary: 59397.94798318194,
      calendarYear: 2037,
      totalDebt: 0.4727280883150673,
      interestRate: 3.4,
      annualInterest: 0.01607275500271229,
      repaymentThreshold: 47266.10863731855,
      annualRepayment: 0.4727280883150673,
      totalRepaid: 6487.910019978241,
      yearsUntilWiped: 15,
    },
  ]);
});
